<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAYA SRL - Financial Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2d3748;
            --accent-color: #3182ce;
            --success-color: #38a169;
            --warning-color: #ed8936;
            --danger-color: #e53e3e;
            --light-bg: #f7fafc;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Semplificato */
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .header .subtitle {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .company-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            letter-spacing: 0.025em;
        }

        /* Controls Eleganti */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--white);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
        }

        .year-selector {
            display: flex;
            background: var(--gray-100);
            border-radius: 12px;
            padding: 0.25rem;
        }

        .year-tab {
            padding: 0.75rem 1.5rem;
            margin: 0;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            color: var(--gray-600);
            min-width: 80px;
        }

        .year-tab.active {
            background: var(--accent-color);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        .year-tab:hover:not(.active) {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .export-btn {
            background: linear-gradient(135deg, var(--success-color), #48bb78);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .export-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* KPI Cards Compatte */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .kpi-card.revenue::before { background: var(--success-color); }
        .kpi-card.costs::before { background: var(--danger-color); }
        .kpi-card.profit::before { background: var(--warning-color); }
        .kpi-card.margin::before { background: var(--accent-color); }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .kpi-icon {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .kpi-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Layout Principale */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-section {
            display: grid;
            gap: 2rem;
        }

        .chart-container {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 300px;
        }

        .chart-wrapper canvas {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chart-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        /* Sidebar Insights */
        .sidebar {
            display: grid;
            gap: 2rem;
        }

        .insights-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
        }

        .insights-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .insights-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            background: var(--gray-50);
            border-left: 4px solid var(--accent-color);
        }

        .insight-icon {
            font-size: 1.25rem;
            margin-top: 0.125rem;
        }

        .insight-text {
            flex: 1;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--gray-700);
        }

        /* Seasonal Analysis */
        .seasonal-section {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .seasonal-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .seasonal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .seasonal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .season-card {
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
        }

        .season-card.spring {
            background: linear-gradient(135deg, #d4edda, #a3d5b8);
            color: var(--gray-800);
        }

        .season-card.summer {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: var(--gray-800);
        }

        .season-card.autumn {
            background: linear-gradient(135deg, #f8d7da, #fab1a0);
            color: var(--gray-800);
        }

        .season-card.winter {
            background: linear-gradient(135deg, #d6eaf8, #74b9ff);
            color: var(--white);
        }

        .season-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .season-months {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .season-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .metric-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .metric-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 700;
        }

        /* Data Table */
        .data-table {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .table-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .number {
            text-align: right;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }

        /* Loading Animation */
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--white);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .seasonal-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        /* Fade In Animation */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Semplificato -->
        <div class="header fade-in">
            <h1>Financial Dashboard</h1>
            <div class="subtitle">Analisi Ricavi, Costi e Marginalit√†</div>
            <div class="company-name">PLAYA SRL</div>
        </div>

        <!-- Controls -->
        <div class="controls fade-in">
            <div class="year-selector">
                <button class="year-tab active" onclick="selectYear(2024)">2024</button>
                <button class="year-tab" onclick="selectYear(2023)">2023</button>
                <button class="year-tab" onclick="selectYear(2022)">2022</button>
            </div>
            <button id="exportBtn" class="export-btn" onclick="generatePDF()">
                <span>üìä</span>
                <span id="exportBtnText">Esporta Report</span>
            </button>
        </div>

        <!-- KPI Cards -->
        <div id="kpi-section" class="fade-in">
            <!-- Generato dinamicamente -->
        </div>

        <!-- Main Grid -->
        <div class="main-grid fade-in">
            <!-- Charts Section -->
            <div class="chart-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Andamento Ricavi vs Costi</div>
                            <div class="chart-subtitle">Confronto mensile delle performance</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Marginalit√† Mensile</div>
                            <div class="chart-subtitle">Percentuale di margine per mese</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="marginChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="insights-card">
                    <div class="insights-header">
                        <span>üí°</span>
                        <div class="insights-title">Key Insights</div>
                    </div>
                    <div id="insights-content">
                        <!-- Generato dinamicamente -->
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Trend Stagionale</div>
                            <div class="chart-subtitle">Andamento ricavi per stagione</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="seasonalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seasonal Analysis -->
        <div id="seasonal-section" class="fade-in">
            <!-- Generato dinamicamente -->
        </div>

        <!-- Data Table -->
        <div id="data-table" class="fade-in">
            <!-- Generato dinamicamente -->
        </div>
    </div>

    <script>
        // Dati ricavi corretti
        const salesData = {
            2024: [
                {month: 'Gen', fullMonth: 'Gennaio', sales: 1297.02},
                {month: 'Feb', fullMonth: 'Febbraio', sales: 627.45},
                {month: 'Mar', fullMonth: 'Marzo', sales: 10592.94},
                {month: 'Apr', fullMonth: 'Aprile', sales: 12017.25},
                {month: 'Mag', fullMonth: 'Maggio', sales: 11246.63},
                {month: 'Giu', fullMonth: 'Giugno', sales: 22305.76},
                {month: 'Lug', fullMonth: 'Luglio', sales: 38623.64},
                {month: 'Ago', fullMonth: 'Agosto', sales: 39212.26},
                {month: 'Set', fullMonth: 'Settembre', sales: 4869.21},
                {month: 'Ott', fullMonth: 'Ottobre', sales: 4309.99},
                {month: 'Nov', fullMonth: 'Novembre', sales: 1111.29},
                {month: 'Dic', fullMonth: 'Dicembre', sales: 8966.99}
            ],
            2023: [
                {month: 'Gen', fullMonth: 'Gennaio', sales: 0},
                {month: 'Feb', fullMonth: 'Febbraio', sales: 0},
                {month: 'Mar', fullMonth: 'Marzo', sales: 0},
                {month: 'Apr', fullMonth: 'Aprile', sales: 0},
                {month: 'Mag', fullMonth: 'Maggio', sales: 591.97},
                {month: 'Giu', fullMonth: 'Giugno', sales: 16826.09},
                {month: 'Lug', fullMonth: 'Luglio', sales: 28047.26},
                {month: 'Ago', fullMonth: 'Agosto', sales: 31562.22},
                {month: 'Set', fullMonth: 'Settembre', sales: 5997.32},
                {month: 'Ott', fullMonth: 'Ottobre', sales: 1309.78},
                {month: 'Nov', fullMonth: 'Novembre', sales: 141.45},
                {month: 'Dic', fullMonth: 'Dicembre', sales: 347.27}
            ],
            2022: [
                {month: 'Gen', fullMonth: 'Gennaio', sales: 0},
                {month: 'Feb', fullMonth: 'Febbraio', sales: 629.55},
                {month: 'Mar', fullMonth: 'Marzo', sales: 0},
                {month: 'Apr', fullMonth: 'Aprile', sales: 0},
                {month: 'Mag', fullMonth: 'Maggio', sales: 7270.37},
                {month: 'Giu', fullMonth: 'Giugno', sales: 19050.58},
                {month: 'Lug', fullMonth: 'Luglio', sales: 22308.42},
                {month: 'Ago', fullMonth: 'Agosto', sales: 20877.43},
                {month: 'Set', fullMonth: 'Settembre', sales: 2321.82},
                {month: 'Ott', fullMonth: 'Ottobre', sales: 509.09},
                {month: 'Nov', fullMonth: 'Novembre', sales: 0},
                {month: 'Dic', fullMonth: 'Dicembre', sales: 0}
            ]
        };

        const costsData = {
            2024: [
                {month: 'Gen', fullMonth: 'Gennaio', costs: 8899.09},
                {month: 'Feb', fullMonth: 'Febbraio', costs: 4806.94},
                {month: 'Mar', fullMonth: 'Marzo', costs: 9394.15},
                {month: 'Apr', fullMonth: 'Aprile', costs: 12299.82},
                {month: 'Mag', fullMonth: 'Maggio', costs: 14141.38},
                {month: 'Giu', fullMonth: 'Giugno', costs: 18169.48},
                {month: 'Lug', fullMonth: 'Luglio', costs: 22874.96},
                {month: 'Ago', fullMonth: 'Agosto', costs: 21481.10},
                {month: 'Set', fullMonth: 'Settembre', costs: 10346.44},
                {month: 'Ott', fullMonth: 'Ottobre', costs: 8354.07},
                {month: 'Nov', fullMonth: 'Novembre', costs: 4234.35},
                {month: 'Dic', fullMonth: 'Dicembre', costs: 8182.91}
            ],
            2023: [
                {month: 'Gen', fullMonth: 'Gennaio', costs: 2523.76},
                {month: 'Feb', fullMonth: 'Febbraio', costs: 1897.88},
                {month: 'Mar', fullMonth: 'Marzo', costs: 2749.55},
                {month: 'Apr', fullMonth: 'Aprile', costs: 1618.33},
                {month: 'Mag', fullMonth: 'Maggio', costs: 3237.84},
                {month: 'Giu', fullMonth: 'Giugno', costs: 13948.20},
                {month: 'Lug', fullMonth: 'Luglio', costs: 18329.06},
                {month: 'Ago', fullMonth: 'Agosto', costs: 22769.98},
                {month: 'Set', fullMonth: 'Settembre', costs: 18497.52},
                {month: 'Ott', fullMonth: 'Ottobre', costs: 6898.07},
                {month: 'Nov', fullMonth: 'Novembre', costs: 7435.73},
                {month: 'Dic', fullMonth: 'Dicembre', costs: 4246.65}
            ],
            2022: [
                {month: 'Gen', fullMonth: 'Gennaio', costs: 870.02},
                {month: 'Feb', fullMonth: 'Febbraio', costs: 1813.49},
                {month: 'Mar', fullMonth: 'Marzo', costs: 1876.19},
                {month: 'Apr', fullMonth: 'Aprile', costs: 1924.49},
                {month: 'Mag', fullMonth: 'Maggio', costs: 6792.50},
                {month: 'Giu', fullMonth: 'Giugno', costs: 17338.44},
                {month: 'Lug', fullMonth: 'Luglio', costs: 19949.90},
                {month: 'Ago', fullMonth: 'Agosto', costs: 15858.14},
                {month: 'Set', fullMonth: 'Settembre', costs: 5731.29},
                {month: 'Ott', fullMonth: 'Ottobre', costs: 7577.64},
                {month: 'Nov', fullMonth: 'Novembre', costs: 2968.74},
                {month: 'Dic', fullMonth: 'Dicembre', costs: 1923.46}
            ]
        };

        let currentYear = 2024;
        let charts = {};

        function formatCurrency(value) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(1) + '%';
        }

        function updateTimestamp() {
            // Rimossa la funzione di aggiornamento timestamp
        }

        function selectYear(year) {
            currentYear = year;
            
            document.querySelectorAll('.year-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadDashboard(year);
        }

        function calculateKPIs(salesData, costsData) {
            const totalSales = salesData.reduce((sum, m) => sum + m.sales, 0);
            const totalCosts = costsData.reduce((sum, m) => sum + m.costs, 0);
            const totalProfit = totalSales - totalCosts;
            const marginPercentage = totalSales > 0 ? totalProfit / totalSales : 0;
            
            const peakSalesMonth = salesData.reduce((max, m) => m.sales > max.sales ? m : max, {sales: 0, fullMonth: 'N/A'});
            
            return {
                totalSales,
                totalCosts,
                totalProfit,
                marginPercentage,
                peakMonth: peakSalesMonth.fullMonth
            };
        }

        function calculateSeasonalData(salesData, costsData) {
            const seasons = {
                spring: { sales: 0, costs: 0, profit: 0 },
                summer: { sales: 0, costs: 0, profit: 0 },
                autumn: { sales: 0, costs: 0, profit: 0 },
                winter: { sales: 0, costs: 0, profit: 0 }
            };

            seasons.spring.sales = salesData[2].sales + salesData[3].sales + salesData[4].sales;
            seasons.spring.costs = costsData[2].costs + costsData[3].costs + costsData[4].costs;
            seasons.spring.profit = seasons.spring.sales - seasons.spring.costs;

            seasons.summer.sales = salesData[5].sales + salesData[6].sales + salesData[7].sales;
            seasons.summer.costs = costsData[5].costs + costsData[6].costs + costsData[7].costs;
            seasons.summer.profit = seasons.summer.sales - seasons.summer.costs;

            seasons.autumn.sales = salesData[8].sales + salesData[9].sales + salesData[10].sales;
            seasons.autumn.costs = costsData[8].costs + costsData[9].costs + costsData[10].costs;
            seasons.autumn.profit = seasons.autumn.sales - seasons.autumn.costs;

            seasons.winter.sales = salesData[11].sales + salesData[0].sales + salesData[1].sales;
            seasons.winter.costs = costsData[11].costs + costsData[0].costs + costsData[1].costs;
            seasons.winter.profit = seasons.winter.sales - seasons.winter.costs;

            return seasons;
        }

        function generateInsights(salesData, costsData, year) {
            const kpis = calculateKPIs(salesData, costsData);
            const insights = [];

            insights.push({
                icon: 'üí∞',
                text: `Il fatturato totale del ${year} √® stato di ${formatCurrency(kpis.totalSales)} con costi operativi pari a ${formatCurrency(kpis.totalCosts)}.`
            });
            
            insights.push({
                icon: 'üìä',
                text: `L'utile operativo registrato √® di ${formatCurrency(kpis.totalProfit)} con un margine del ${formatPercentage(kpis.marginPercentage)}.`
            });
            
            insights.push({
                icon: 'üèÜ',
                text: `Il mese con le migliori performance √® stato ${kpis.peakMonth} in termini di ricavi.`
            });

            const seasonal = calculateSeasonalData(salesData, costsData);
            const bestSeason = Object.entries(seasonal)
                .reduce((max, [name, data]) => data.profit > max.profit ? {name, ...data} : max, {name: '', profit: -Infinity});
            
            const seasonNames = {
                'spring': 'Primavera',
                'summer': 'Estate', 
                'autumn': 'Autunno',
                'winter': 'Inverno'
            };
            
            insights.push({
                icon: 'üåü',
                text: `La stagione pi√π profittevole √® risultata l'${seasonNames[bestSeason.name]} con un utile di ${formatCurrency(bestSeason.profit)}.`
            });

            return insights;
        }

        function loadDashboard(year) {
            const sales = salesData[year];
            const costs = costsData[year];
            const kpis = calculateKPIs(sales, costs);
            const seasonalData = calculateSeasonalData(sales, costs);
            const insights = generateInsights(sales, costs, year);

            // Aggiorna KPI Cards
            document.getElementById('kpi-section').innerHTML = `
                <div class="kpi-grid">
                    <div class="kpi-card revenue">
                        <div class="kpi-header">
                            <div class="kpi-icon">üí∞</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(kpis.totalSales)}</div>
                        <div class="kpi-label">Ricavi Totali</div>
                    </div>
                    <div class="kpi-card costs">
                        <div class="kpi-header">
                            <div class="kpi-icon">üìâ</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(kpis.totalCosts)}</div>
                        <div class="kpi-label">Costi Totali</div>
                    </div>
                    <div class="kpi-card profit">
                        <div class="kpi-header">
                            <div class="kpi-icon">üìà</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(kpis.totalProfit)}</div>
                        <div class="kpi-label">Utile Operativo</div>
                    </div>
                    <div class="kpi-card margin">
                        <div class="kpi-header">
                            <div class="kpi-icon">üéØ</div>
                        </div>
                        <div class="kpi-value">${formatPercentage(kpis.marginPercentage)}</div>
                        <div class="kpi-label">Margine Operativo</div>
                    </div>
                </div>
            `;

            // Aggiorna Insights
            document.getElementById('insights-content').innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');

            // Aggiorna Seasonal Analysis
            document.getElementById('seasonal-section').innerHTML = `
                <div class="seasonal-section">
                    <div class="seasonal-header">
                        <div class="seasonal-title">Analisi Stagionale ${year}</div>
                    </div>
                    <div class="seasonal-grid">
                        <div class="season-card spring">
                            <div class="season-title">üå∏ Primavera</div>
                            <div class="season-months">Marzo ‚Ä¢ Aprile ‚Ä¢ Maggio</div>
                            <div class="season-metrics">
                                <div class="metric-item">
                                    <div class="metric-label">Ricavi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.spring.sales)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Costi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.spring.costs)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Utile</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.spring.profit)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Margine</div>
                                    <div class="metric-value">${formatPercentage(seasonalData.spring.sales > 0 ? seasonalData.spring.profit / seasonalData.spring.sales : 0)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="season-card summer">
                            <div class="season-title">‚òÄÔ∏è Estate</div>
                            <div class="season-months">Giugno ‚Ä¢ Luglio ‚Ä¢ Agosto</div>
                            <div class="season-metrics">
                                <div class="metric-item">
                                    <div class="metric-label">Ricavi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.summer.sales)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Costi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.summer.costs)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Utile</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.summer.profit)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Margine</div>
                                    <div class="metric-value">${formatPercentage(seasonalData.summer.sales > 0 ? seasonalData.summer.profit / seasonalData.summer.sales : 0)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="season-card autumn">
                            <div class="season-title">üçÇ Autunno</div>
                            <div class="season-months">Settembre ‚Ä¢ Ottobre ‚Ä¢ Novembre</div>
                            <div class="season-metrics">
                                <div class="metric-item">
                                    <div class="metric-label">Ricavi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.autumn.sales)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Costi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.autumn.costs)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Utile</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.autumn.profit)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Margine</div>
                                    <div class="metric-value">${formatPercentage(seasonalData.autumn.sales > 0 ? seasonalData.autumn.profit / seasonalData.autumn.sales : 0)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="season-card winter">
                            <div class="season-title">‚ùÑÔ∏è Inverno</div>
                            <div class="season-months">Dicembre ‚Ä¢ Gennaio ‚Ä¢ Febbraio</div>
                            <div class="season-metrics">
                                <div class="metric-item">
                                    <div class="metric-label">Ricavi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.winter.sales)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Costi</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.winter.costs)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Utile</div>
                                    <div class="metric-value">${formatCurrency(seasonalData.winter.profit)}</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Margine</div>
                                    <div class="metric-value">${formatPercentage(seasonalData.winter.sales > 0 ? seasonalData.winter.profit / seasonalData.winter.sales : 0)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Aggiorna Data Table
            document.getElementById('data-table').innerHTML = `
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">Dettaglio Mensile ${year}</div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Periodo</th>
                                    <th class="number">Ricavi</th>
                                    <th class="number">Costi</th>
                                    <th class="number">Utile</th>
                                    <th class="number">Margine %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sales.map((month, index) => {
                                    const profit = month.sales - costs[index].costs;
                                    const margin = month.sales > 0 ? (profit / month.sales) * 100 : 0;
                                    return `
                                        <tr>
                                            <td><strong>${month.fullMonth}</strong></td>
                                            <td class="number">${formatCurrency(month.sales)}</td>
                                            <td class="number">${formatCurrency(costs[index].costs)}</td>
                                            <td class="number ${profit >= 0 ? 'positive' : 'negative'}">${formatCurrency(profit)}</td>
                                            <td class="number ${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Distruggi i grafici esistenti
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Crea i grafici
            setTimeout(() => {
                createRevenueChart(sales, costs, year);
                createMarginChart(sales, costs, year);
                createSeasonalChart(seasonalData, year);
            }, 100);
        }

        function createRevenueChart(salesData, costsData, year) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: salesData.map(d => d.month),
                    datasets: [{
                        label: 'Ricavi',
                        data: salesData.map(d => d.sales),
                        borderColor: '#38a169',
                        backgroundColor: 'rgba(56, 161, 105, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#38a169',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }, {
                        label: 'Costi',
                        data: costsData.map(d => d.costs),
                        borderColor: '#e53e3e',
                        backgroundColor: 'rgba(229, 62, 62, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#e53e3e',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + (value / 1000).toFixed(0) + 'k';
                                },
                                font: {
                                    size: 11
                                },
                                color: '#6b7280'
                            },
                            grid: {
                                color: '#f3f4f6',
                                borderColor: '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                color: '#6b7280'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    }
                }
            });
        }

        function createMarginChart(salesData, costsData, year) {
            const ctx = document.getElementById('marginChart').getContext('2d');
            
            const margins = salesData.map((s, i) => {
                const profit = s.sales - costsData[i].costs;
                return s.sales > 0 ? (profit / s.sales) * 100 : 0;
            });

            charts.margin = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: salesData.map(d => d.month),
                    datasets: [{
                        label: 'Margine %',
                        data: margins,
                        backgroundColor: margins.map(m => m >= 0 ? 'rgba(56, 161, 105, 0.8)' : 'rgba(229, 62, 62, 0.8)'),
                        borderColor: margins.map(m => m >= 0 ? '#38a169' : '#e53e3e'),
                        borderWidth: 0,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                },
                                font: {
                                    size: 11
                                },
                                color: '#6b7280'
                            },
                            grid: {
                                color: '#f3f4f6',
                                borderColor: '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                color: '#6b7280'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    }
                }
            });
        }

        function createSeasonalChart(seasonalData, year) {
            const ctx = document.getElementById('seasonalChart').getContext('2d');
            
            // Crea una curva gaussiana per rappresentare la stagionalit√†
            const seasons = ['Inverno', 'Primavera', 'Estate', 'Autunno'];
            const salesValues = [
                seasonalData.winter.sales,
                seasonalData.spring.sales, 
                seasonalData.summer.sales,
                seasonalData.autumn.sales
            ];
            const profitValues = [
                seasonalData.winter.profit,
                seasonalData.spring.profit,
                seasonalData.summer.profit,
                seasonalData.autumn.profit
            ];
            
            charts.seasonal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: seasons,
                    datasets: [{
                        label: 'Ricavi Stagionali',
                        data: salesValues,
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3182ce',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }, {
                        label: 'Profitti Stagionali',
                        data: profitValues,
                        borderColor: '#38a169',
                        backgroundColor: 'rgba(56, 161, 105, 0.1)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#38a169',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 11,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = formatCurrency(context.parsed.y);
                                    return label + ': ' + value;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + (value / 1000).toFixed(0) + 'k';
                                },
                                font: {
                                    size: 11
                                },
                                color: '#6b7280'
                            },
                            grid: {
                                color: '#f3f4f6',
                                borderColor: '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                color: '#374151'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    },
                    elements: {
                        line: {
                            borderJoinStyle: 'round'
                        }
                    }
                }
            });
        }

        // Funzione PDF ottimizzata
        function generatePDF() {
            const exportBtn = document.getElementById('exportBtn');
            const exportBtnText = document.getElementById('exportBtnText');
            
            exportBtn.disabled = true;
            exportBtnText.innerHTML = '<div class="loading-spinner"></div> Generando...';
            
            try {
                const sales = salesData[currentYear];
                const costs = costsData[currentYear];
                const kpis = calculateKPIs(sales, costs);
                const seasonalData = calculateSeasonalData(sales, costs);
                const insights = generateInsights(sales, costs, currentYear);
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 20;
                const contentWidth = pageWidth - 2 * margin;
                let currentY = margin;
                
                function checkNewPage(neededHeight) {
                    if (currentY + neededHeight > pageHeight - margin) {
                        pdf.addPage();
                        currentY = margin;
                        return true;
                    }
                    return false;
                }
                
                function drawColoredRect(x, y, width, height, color) {
                    pdf.setFillColor(color[0], color[1], color[2]);
                    pdf.rect(x, y, width, height, 'F');
                }
                
                // HEADER PROFESSIONALE
                pdf.setFontSize(26);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(26, 54, 93);
                pdf.text('PLAYA SRL', margin, currentY);
                currentY += 8;
                
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(107, 114, 128);
                pdf.text(`Financial Dashboard - Anno ${currentYear}`, margin, currentY);
                currentY += 6;
                
                pdf.setFontSize(10);
                pdf.text(`Generato il ${new Date().toLocaleDateString('it-IT')} | P.IVA: 04805160233`, margin, currentY);
                currentY += 20;
                
                // Linea elegante
                pdf.setDrawColor(229, 231, 235);
                pdf.setLineWidth(0.5);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 20;
                
                // KPI EXECUTIVE SUMMARY
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(17, 24, 39);
                pdf.text('Executive Summary', margin, currentY);
                currentY += 15;
                
                const cardWidth = (contentWidth - 15) / 3;
                const cardHeight = 25;
                
                // Card Ricavi
                drawColoredRect(margin, currentY, cardWidth, cardHeight, [56, 161, 105]);
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'bold');
                pdf.text('RICAVI TOTALI', margin + 5, currentY + 6);
                pdf.setFontSize(16);
                pdf.text(formatCurrency(kpis.totalSales), margin + 5, currentY + 18);
                
                // Card Costi
                drawColoredRect(margin + cardWidth + 7.5, currentY, cardWidth, cardHeight, [229, 62, 62]);
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'bold');
                pdf.text('COSTI TOTALI', margin + cardWidth + 12.5, currentY + 6);
                pdf.setFontSize(16);
                pdf.text(formatCurrency(kpis.totalCosts), margin + cardWidth + 12.5, currentY + 18);
                
                // Card Utile
                const profitColor = kpis.totalProfit >= 0 ? [237, 137, 54] : [229, 62, 62];
                drawColoredRect(margin + 2 * cardWidth + 15, currentY, cardWidth, cardHeight, profitColor);
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'bold');
                pdf.text('UTILE OPERATIVO', margin + 2 * cardWidth + 20, currentY + 6);
                pdf.setFontSize(16);
                pdf.text(formatCurrency(kpis.totalProfit), margin + 2 * cardWidth + 20, currentY + 18);
                
                currentY += cardHeight + 25;
                pdf.setTextColor(17, 24, 39);
                
                // TABELLA DATI DETTAGLIATA
                checkNewPage(80);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Analisi Mensile Dettagliata', margin, currentY);
                currentY += 15;
                
                // Header tabella elegante
                const colWidths = [35, 32, 32, 32, 32];
                let startX = margin;
                
                drawColoredRect(startX, currentY, contentWidth, 10, [249, 250, 251]);
                pdf.setFillColor(17, 24, 39);
                pdf.rect(startX, currentY, contentWidth, 2, 'F');
                
                pdf.setTextColor(75, 85, 99);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'bold');
                pdf.text('MESE', startX + 2, currentY + 7);
                pdf.text('RICAVI', startX + colWidths[0] + 2, currentY + 7);
                pdf.text('COSTI', startX + colWidths[0] + colWidths[1] + 2, currentY + 7);
                pdf.text('UTILE', startX + colWidths[0] + colWidths[1] + colWidths[2] + 2, currentY + 7);
                pdf.text('MARGINE %', startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, currentY + 7);
                
                currentY += 10;
                
                // Righe dati con styling alternato
                sales.forEach((month, index) => {
                    checkNewPage(7);
                    
                    const profit = month.sales - costs[index].costs;
                    const margin = month.sales > 0 ? (profit / month.sales) * 100 : 0;
                    
                    if (index % 2 === 0) {
                        drawColoredRect(startX, currentY, contentWidth, 6, [249, 250, 251]);
                    }
                    
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(55, 65, 81);
                    
                    pdf.text(month.fullMonth, startX + 2, currentY + 4);
                    pdf.text(formatCurrency(month.sales), startX + colWidths[0] + 2, currentY + 4);
                    pdf.text(formatCurrency(costs[index].costs), startX + colWidths[0] + colWidths[1] + 2, currentY + 4);
                    
                    pdf.setTextColor(profit >= 0 ? 56 : 229, profit >= 0 ? 161 : 62, profit >= 0 ? 105 : 62);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(formatCurrency(profit), startX + colWidths[0] + colWidths[1] + colWidths[2] + 2, currentY + 4);
                    pdf.text(margin.toFixed(1) + '%', startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, currentY + 4);
                    
                    currentY += 6;
                });
                
                currentY += 20;
                
                // ANALISI STAGIONALE PROFESSIONALE
                checkNewPage(60);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(17, 24, 39);
                pdf.text('Analisi Performance Stagionali', margin, currentY);
                currentY += 15;
                
                const seasonCardWidth = (contentWidth - 15) / 2;
                const seasonCardHeight = 30;
                
                const seasons = [
                    { name: 'PRIMAVERA', data: seasonalData.spring, color: [163, 213, 184] },
                    { name: 'ESTATE', data: seasonalData.summer, color: [255, 234, 167] },
                    { name: 'AUTUNNO', data: seasonalData.autumn, color: [250, 177, 160] },
                    { name: 'INVERNO', data: seasonalData.winter, color: [116, 185, 255] }
                ];
                
                seasons.forEach((season, index) => {
                    const x = margin + (index % 2) * (seasonCardWidth + 7.5);
                    const y = currentY + Math.floor(index / 2) * (seasonCardHeight + 10);
                    
                    drawColoredRect(x, y, seasonCardWidth, seasonCardHeight, season.color);
                    
                    pdf.setTextColor(55, 65, 81);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(season.name, x + 5, y + 8);
                    
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`Ricavi: ${formatCurrency(season.data.sales)}`, x + 5, y + 15);
                    pdf.text(`Costi: ${formatCurrency(season.data.costs)}`, x + 5, y + 19);
                    pdf.text(`Utile: ${formatCurrency(season.data.profit)}`, x + 5, y + 23);
                    const seasonMargin = season.data.sales > 0 ? season.data.profit / season.data.sales : 0;
                    pdf.text(`Margine: ${formatPercentage(seasonMargin)}`, x + 5, y + 27);
                });
                
                currentY += seasonCardHeight * 2 + 30;
                
                // INSIGHTS AZIENDALI
                checkNewPage(40);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(17, 24, 39);
                pdf.text('Key Business Insights', margin, currentY);
                currentY += 15;
                
                insights.forEach(insight => {
                    checkNewPage(12);
                    
                    // Bullet point elegante
                    pdf.setFillColor(49, 130, 206);
                    pdf.circle(margin + 3, currentY - 1, 1, 'F');
                    
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(55, 65, 81);
                    
                    const lines = pdf.splitTextToSize(insight.text, contentWidth - 15);
                    pdf.text(lines, margin + 8, currentY);
                    currentY += lines.length * 4 + 3;
                });
                
                // FOOTER PROFESSIONALE
                currentY += 20;
                checkNewPage(25);
                
                pdf.setDrawColor(229, 231, 235);
                pdf.setLineWidth(0.5);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 10;
                
                pdf.setFontSize(7);
                pdf.setTextColor(156, 163, 175);
                pdf.text('PLAYA SRL | Via Esempio 123, Verona | P.IVA: 04805160233', margin, currentY);
                pdf.text(`Report confidenziale generato il ${new Date().toLocaleDateString('it-IT')}`, margin, currentY + 4);
                pdf.text('Documento riservato - Solo per uso interno aziendale', pageWidth - margin - 70, currentY + 4);
                
                // Salva il PDF con nome professionale
                const fileName = `PLAYA_SRL_Financial_Report_${currentYear}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                // Feedback positivo
                setTimeout(() => {
                    alert('‚úÖ Report esportato con successo!\n\nIl documento PDF √® stato generato e scaricato.');
                }, 100);
                
            } catch (error) {
                console.error('Errore durante l\'esportazione:', error);
                alert('‚ùå Errore durante l\'esportazione del report.\n\nRiprova o contatta il supporto tecnico.');
            } finally {
                exportBtn.disabled = false;
                exportBtnText.innerHTML = 'Esporta Report';
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard(currentYear);
        });
    </script>
</body>
</html>
